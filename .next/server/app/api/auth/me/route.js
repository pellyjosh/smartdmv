(()=>{var e={};e.id=673,e.ids=[673],e.modules={171:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{GET:()=>u});var n=r(32190),o=r(44999),i=r(42154),a=r(75280),l=r(94634),c=r(53777),d=e([i]);async function u(e){console.log("[API ME START] Received request to /api/auth/me");let t=(await o.UL()).get(c.CF)?.value;if(!t)return console.log("[API ME] No httpOnly session token found. Returning null."),n.NextResponse.json(null,{status:200});console.log("[API ME] Found httpOnly session token (value logged as ****** for security)");try{let e;let r=await i.db.query.sessions.findFirst({where:(0,l.eq)(a.sessions.id,t)});if(!r){console.log(`[API ME] Session ID from cookie not found in DB: ${t}. Clearing cookie.`);let e=n.NextResponse.json(null,{status:200});return e.cookies.set(c.CF,"",{httpOnly:!0,maxAge:0,path:"/"}),e}console.log("[API ME] Session found in DB for token:",r.id);let s="number"==typeof r.expiresAt?r.expiresAt:new Date(r.expiresAt).getTime(),o=Date.now();if(s<o){console.log(`[API ME] Session expired. ExpiresAt_ms: ${s}, CurrentTime_ms: ${o}. Deleting session and clearing cookie.`),await i.db.delete(a.sessions).where((0,l.eq)(a.sessions.id,t));let e=n.NextResponse.json(null,{status:200});return e.cookies.set(c.CF,"",{httpOnly:!0,maxAge:0,path:"/"}),e}console.log("[API ME] Session is valid and not expired.");let d=await i.db.query.users.findFirst({where:(0,l.eq)(a.users.id,r.userId)});if(!d){console.error(`[API ME] User not found for session ID: ${t}, userId: ${r.userId}. Deleting orphaned session and clearing cookie.`),await i.db.delete(a.sessions).where((0,l.eq)(a.sessions.id,t));let e=n.NextResponse.json(null,{status:200});return e.cookies.set(c.CF,"",{httpOnly:!0,maxAge:0,path:"/"}),e}if(console.log("[API ME] User record found for session:",d.email),"ADMINISTRATOR"===d.role){let t=(await i.db.select({practiceId:a.administratorAccessiblePractices.practiceId}).from(a.administratorAccessiblePractices).where((0,l.eq)(a.administratorAccessiblePractices.administratorId,d.id))).map(e=>e.practiceId),r=d.currentPracticeId;0===t.length?(console.warn(`[API ME] Administrator ${d.email} has no accessible practices. Setting currentPracticeId to 'practice_NONE'.`),r="practice_NONE"):r&&t.includes(r)||(console.warn(`[API ME] Administrator ${d.email}'s currentPracticeId (${r}) is invalid or not set. Defaulting to first accessible: ${t[0]}.`),r=t[0]),e={id:d.id,email:d.email,name:d.name||void 0,role:"ADMINISTRATOR",accessiblePracticeIds:t,currentPracticeId:r}}else if("PRACTICE_ADMINISTRATOR"===d.role){if(!d.practiceId){console.warn(`[API ME] Practice Administrator ${d.email} is not associated with a practice. Returning null.`);let e=n.NextResponse.json(null,{status:200});return e.cookies.set(c.CF,"",{httpOnly:!0,maxAge:0,path:"/"}),e}e={id:d.id,email:d.email,name:d.name||void 0,role:"PRACTICE_ADMINISTRATOR",practiceId:d.practiceId}}else if("CLIENT"===d.role){if(!d.practiceId){console.warn(`[API ME] Client ${d.email} is not associated with a practice. Returning null.`);let e=n.NextResponse.json(null,{status:200});return e.cookies.set(c.CF,"",{httpOnly:!0,maxAge:0,path:"/"}),e}e={id:d.id,email:d.email,name:d.name||void 0,role:"CLIENT",practiceId:d.practiceId}}else{console.error(`[API ME] Unknown user role for ${d.email}: ${d.role}. Clearing cookie and returning null.`);let e=n.NextResponse.json(null,{status:200});return e.cookies.set(c.CF,"",{httpOnly:!0,maxAge:0,path:"/"}),e}return console.log("[API ME SUCCESS] Successfully fetched user data:",e.email,e.role,"Current Practice ID (if admin):",e.currentPracticeId),n.NextResponse.json(e)}catch(t){console.error("[API ME CATCH_ERROR] Error fetching current user:",t);let e=n.NextResponse.json({error:"Failed to fetch user session"},{status:500});return e.cookies.set(c.CF,"",{httpOnly:!0,maxAge:0,path:"/"}),e}}i=(d.then?(await d)():d)[0],s()}catch(e){s(e)}})},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},21820:e=>{"use strict";e.exports=require("os")},24948:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{patchFetch:()=>c,routeModule:()=>d,serverHooks:()=>m,workAsyncStorage:()=>u,workUnitAsyncStorage:()=>p});var n=r(96559),o=r(48088),i=r(37719),a=r(171),l=e([a]);a=(l.then?(await l)():l)[0];let d=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/auth/me/route",pathname:"/api/auth/me",filename:"route",bundlePath:"app/api/auth/me/route"},resolvedPagePath:"/Users/Hubolux/Documents/Project 001/HuboluxJobs/smartdmv/src/app/api/auth/me/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:u,workUnitAsyncStorage:p,serverHooks:m}=d;function c(){return(0,i.patchFetch)({workAsyncStorage:u,workUnitAsyncStorage:p})}s()}catch(e){s(e)}})},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},42154:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{let p;r.d(t,{db:()=>f});var n=r(97329),o=r(72094),i=r(11913),a=r(64939),l=r(87550),c=r.n(l),d=r(75280),u=e([a,o]);[a,o]=u.then?(await u)():u,(0,n.config)();let m=process.env.DB_TYPE||"postgres";if(console.log(`[DB_INIT] DB_TYPE set to: ${m}`),"postgres"===m){let e;if(!process.env.POSTGRES_URL)throw Error('POSTGRES_URL environment variable is not set for DB_TYPE="postgres".');console.log("\uD83D\uDD0C Connecting to PostgreSQL database..."),e=new a.Pool({connectionString:process.env.POSTGRES_URL}),p=(0,o.fd)(e,{schema:d,logger:!1}),console.log("âœ… PostgreSQL Drizzle instance created.")}else if("sqlite"===m){let e;if(!process.env.SQLITE_DB_PATH)throw Error('SQLITE_DB_PATH environment variable is not set for DB_TYPE="sqlite".');console.log(`ðŸ”Œ Connecting to SQLite database at: ${process.env.SQLITE_DB_PATH}`),e=new(c())(process.env.SQLITE_DB_PATH),p=(0,i.f)(e,{schema:d,logger:!1}),console.log("âœ… SQLite Drizzle instance created.")}else throw Error(`Unsupported DB_TYPE: ${m}. Must be "postgres" or "sqlite".`);let f=p;s()}catch(e){s(e)}})},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},53777:(e,t,r)=>{"use strict";r.d(t,{CF:()=>s,M9:()=>n});let s="session_token",n=604800},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},64939:e=>{"use strict";e.exports=import("pg")},75280:(e,t,r)=>{"use strict";r.r(t),r.d(t,{administratorAccessiblePractices:()=>w,administratorAccessiblePracticesRelations:()=>D,practices:()=>E,practicesRelations:()=>g,schema:()=>v,sessions:()=>_,sessionsRelations:()=>N,userRoleEnum:()=>M,users:()=>y,usersRelations:()=>x});var s=r(57033),n=r(29334),o=r(58152),i=r(9253),a=r(28234),l=r(89283),c=r(77301),d=r(70932);let u=process.env.DB_TYPE||"postgres",p=(e,t,r)=>"sqlite"===u?a.D(e,t,r):s.cJ(e,t,r),m=(e,t)=>"sqlite"===u?l.Qq(e):n.Qq(e),f="sqlite"===u?c.ie:o.ie,A=(e,t)=>"sqlite"===u?d.nd():i.vE(e);var I=r(96657),P=r(64073);let T="sqlite"===process.env.DB_TYPE,E=p("practices",{id:m("id").primaryKey().$defaultFn(()=>crypto.randomUUID()),name:m("name").notNull(),createdAt:T?A("createdAt",{mode:"timestamp_ms"}).notNull().default((0,I.ll)`CURRENT_TIMESTAMP`):A("createdAt",{mode:"date"}).default((0,I.ll)`CURRENT_TIMESTAMP`).notNull(),updatedAt:T?A("updatedAt",{mode:"timestamp_ms"}).notNull().default((0,I.ll)`CURRENT_TIMESTAMP`).$onUpdate(()=>(0,I.ll)`CURRENT_TIMESTAMP`):A("updatedAt",{mode:"date"}).default((0,I.ll)`CURRENT_TIMESTAMP`).notNull()}),g=(0,P.K1)(E,({many:e})=>({usersPractice:e(y,{relationName:"usersPracticeRelation"}),usersCurrentPractice:e(y,{relationName:"usersCurrentPracticeRelation"}),accessibleToAdmins:e(w)})),R="sqlite"===process.env.DB_TYPE,_=p("sessions",{id:m("id").primaryKey().$defaultFn(()=>crypto.randomUUID()),userId:m("user_id").notNull().references(()=>y.id,{onDelete:"cascade"}),expiresAt:R?A("expiresAt",{mode:"timestamp_ms"}).notNull():A("expiresAt").notNull(),data:m("data"),createdAt:R?A("createdAt",{mode:"timestamp_ms"}).notNull().default((0,I.ll)`CURRENT_TIMESTAMP`):A("createdAt",{mode:"date"}).notNull().default((0,I.ll)`CURRENT_TIMESTAMP`)}),N=(0,P.K1)(_,({one:e})=>({user:e(y,{fields:[_.userId],references:[y.id]})})),h="sqlite"===process.env.DB_TYPE,M=["CLIENT","PRACTICE_ADMINISTRATOR","ADMINISTRATOR"],y=p("users",{id:m("id").primaryKey().$defaultFn(()=>crypto.randomUUID()),email:m("email").notNull().unique(),name:m("name"),password:m("password").notNull(),role:m("role",{enum:M}).notNull(),practiceId:m("practice_id").references(()=>E.id,{onDelete:"set null"}),currentPracticeId:m("current_practice_id").references(()=>E.id,{onDelete:"set null"}),createdAt:h?A("createdAt",{mode:"timestamp_ms"}).notNull().default((0,I.ll)`(strftime('%s', 'now') * 1000)`):A("createdAt",{mode:"date"}).default((0,I.ll)`CURRENT_TIMESTAMP`).notNull(),updatedAt:h?A("updatedAt",{mode:"timestamp_ms"}).notNull().default((0,I.ll)`(strftime('%s', 'now') * 1000)`).$onUpdate(()=>(0,I.ll)`(strftime('%s', 'now') * 1000)`):A("updatedAt",{mode:"date"}).notNull().default((0,I.ll)`CURRENT_TIMESTAMP`).$onUpdateFn(()=>new Date)}),w=p("administrator_accessible_practices",{administratorId:m("administrator_id").notNull().references(()=>y.id,{onDelete:"cascade"}),practiceId:m("practice_id").notNull().references(()=>E.id,{onDelete:"cascade"}),assignedAt:h?A("assignedAt",{mode:"timestamp_ms"}).notNull().default((0,I.ll)`(strftime('%s', 'now') * 1000)`):A("assignedAt",{mode:"date"}).notNull().default((0,I.ll)`CURRENT_TIMESTAMP`),createdAt:h?A("createdAt",{mode:"timestamp_ms"}).notNull().default((0,I.ll)`(strftime('%s', 'now') * 1000)`):A("createdAt",{mode:"date"}).notNull().default((0,I.ll)`CURRENT_TIMESTAMP`),updatedAt:h?A("updatedAt",{mode:"timestamp_ms"}).notNull().default((0,I.ll)`(strftime('%s', 'now') * 1000)`).$onUpdate(()=>(0,I.ll)`(strftime('%s', 'now') * 1000)`):A("updatedAt",{mode:"date"}).notNull().default((0,I.ll)`CURRENT_TIMESTAMP`).$onUpdateFn(()=>new Date)},e=>({pk:f({columns:[e.administratorId,e.practiceId]})})),x=(0,P.K1)(y,({one:e,many:t})=>({assignedPractice:e(E,{fields:[y.practiceId],references:[E.id],relationName:"usersPracticeRelation"}),currentSelectedPractice:e(E,{fields:[y.currentPracticeId],references:[E.id],relationName:"usersCurrentPracticeRelation"}),accessiblePractices:t(w),sessions:t(_)})),D=(0,P.K1)(w,({one:e})=>({administrator:e(y,{fields:[w.administratorId],references:[y.id]}),practice:e(E,{fields:[w.practiceId],references:[E.id]})})),v={users:y,practices:E,sessions:_,administratorAccessiblePractices:w}},76926:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"createDedupedByCallsiteServerErrorLoggerDev",{enumerable:!0,get:function(){return l}});let s=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=n(t);if(r&&r.has(e))return r.get(e);var s={__proto__:null},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if("default"!==i&&Object.prototype.hasOwnProperty.call(e,i)){var a=o?Object.getOwnPropertyDescriptor(e,i):null;a&&(a.get||a.set)?Object.defineProperty(s,i,a):s[i]=e[i]}return s.default=e,r&&r.set(e,s),s}(r(61120));function n(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(n=function(e){return e?r:t})(e)}let o={current:null},i="function"==typeof s.cache?s.cache:e=>e,a=console.warn;function l(e){return function(...t){a(e(...t))}}i(e=>{try{a(o.current)}finally{o.current=null}})},78335:()=>{},87550:e=>{"use strict";e.exports=require("better-sqlite3")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[447,580,558],()=>r(24948));module.exports=s})();